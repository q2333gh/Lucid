name: Build

# TODO github CI should cache: wasi2ic and polyfill library build artifacts.
# TODO consider save cdk-c and c_candid .a lib as github release assets.
on:
  push:
  #   branches: ["main", "master"]
  # pull_request:
  #   branches: ["main", "master"]
    tags:
      - "*"  # run only when a tag is pushed

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.11"
      WASI_SDK_VERSION: "25.0"
      # The tarball extracts to a folder named wasi-sdk-25.0-x86_64-linux
      WASI_SDK_ROOT: "/opt/wasi-sdk/wasi-sdk-25.0-x86_64-linux"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake clang lld ninja-build binaryen libcriterion-dev

      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache WASI SDK
        id: cache-wasi
        uses: actions/cache@v4
        with:
          path: /opt/wasi-sdk
          key: wasi-sdk-${{ env.WASI_SDK_VERSION }}-v2

      - name: Download WASI SDK
        if: steps.cache-wasi.outputs.cache-hit != 'true'
        run: |
          mkdir -p /opt/wasi-sdk
          # Use the correct URL for x86_64 Linux (tar.gz)
          curl -L "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-25/wasi-sdk-${WASI_SDK_VERSION}-x86_64-linux.tar.gz" \
            | sudo tar -xz -C /opt/wasi-sdk

      - name: Native build
        run: python build.py

      - name: WASI build
        run: python build.py --icwasm

      - name: Prepare release assets
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p dist
          test -f build_lib/wasi2ic
          test -f build_lib/libic_wasi_polyfill.a
          cp build_lib/wasi2ic dist/wasi2ic-linux-amd64
          cp build_lib/libic_wasi_polyfill.a dist/libic_wasi_polyfill.a
          tar -C dist -czf dist/wasi2ic-linux-amd64.tar.gz wasi2ic-linux-amd64
          tar -C dist -czf dist/libic_wasi_polyfill.a.tar.gz libic_wasi_polyfill.a

      - name: Publish release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/wasi2ic-linux-amd64.tar.gz
            dist/libic_wasi_polyfill.a.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

