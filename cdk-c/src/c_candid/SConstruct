# SConstruct
import os
import shutil
from SCons.Script import Default, Environment, Glob, Alias, AlwaysBuild, Delete, COMMAND_LINE_TARGETS

# ----------------------
# Environment configuration
# ----------------------
default_cc = os.environ.get("CC", "clang")
default_ar = os.environ.get("AR", None)
if default_ar is None:
    default_ar = "llvm-ar" if shutil.which("llvm-ar") else "ar"

ROOT = os.path.dirname(os.path.abspath("SConstruct"))
BUILD_DIR = os.path.join(ROOT, "build", "runtime")
OBJ_DIR = os.path.join(BUILD_DIR, "obj")
BIN_DIR = os.path.join(BUILD_DIR, "bin")

env = Environment(
    CC=default_cc,
    AR=default_ar,
    CFLAGS=[
        "-std=c11",
        "-Wall",
        "-Wextra",
        "-pedantic",
        "-Iruntime/runtime/include"
    ] + os.environ.get("CFLAGS", "").split(),
)

# ----------------------
# runtime static library
# ----------------------
runtime_src = Glob("runtime/runtime/src/*.c")
runtime_objs = [
    env.Object(os.path.join(OBJ_DIR, os.path.splitext(src.name)[0] + ".o"), src)
    for src in runtime_src
]
lib_runtime = env.Library(BUILD_DIR + "/candid_runtime", runtime_objs)

Alias("runtime", lib_runtime)

# ----------------------
# stub executables
# ----------------------
encode_bin = env.Program(
    os.path.join(BIN_DIR, "c_candid_encode"),
    ["runtime/src/c_candid_encode.c"],
    LIBS=[lib_runtime],
    LIBPATH=[BUILD_DIR]
)

decode_bin = env.Program(
    os.path.join(BIN_DIR, "c_candid_decode"),
    ["runtime/src/c_candid_decode.c"],
    LIBS=[lib_runtime],
    LIBPATH=[BUILD_DIR]
)

Alias("bins", [encode_bin, decode_bin])

# ----------------------
# test program
# ----------------------
test_bin = env.Program(
    os.path.join(BIN_DIR, "runtime_tests"),
    ["runtime/tests/runtime_tests.c"],
    LIBS=[lib_runtime],
    LIBPATH=[BUILD_DIR]
)

# test action
test_runner = env.Command(
    target="run_tests",
    source=test_bin,
    action=str(test_bin[0].abspath),
)
AlwaysBuild(test_runner)
Alias("tests", test_runner)

# ----------------------
# all = runtime + bins + tests
# ----------------------
Alias("all", [lib_runtime, encode_bin, decode_bin, test_runner])

# ----------------------
# clean
# ----------------------
if "clean" in COMMAND_LINE_TARGETS:
    Delete(BUILD_DIR)
