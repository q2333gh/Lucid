# Development Guide

## IDE Support

clangd behaves best when host-only compile commands are separated from the WASM toolchain flags. Keep two databases and merge them when needed:

- `cdk-c/test/build/compile_commands.json`: host Criterion build produced by CMake.
- `cdk-c/build/compile_commands.json`: WASM build info generated by the Python + Bear flow.
- `cdk-c/compile_commands.json`: merged database written by `cdk-c/scripts/merge_compile_commands.py` and consumed by clangd/VS Code. (Optional: symlink `compile_commands.json` at the repo root for other tooling.)

### Host compile database (clangd)

```bash
cd cdk-c
cmake -S test -B test/build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
```

- `cmake ... -DCMAKE_EXPORT_COMPILE_COMMANDS=ON` emits the host `compile_commands.json` inside `cdk-c/test/build/`.
- Re-run whenever you clean `cdk-c/test/build/` or install new headers.

### WASM compile database (optional tooling)

Your existing Bear flow still works; just redirect its output so it does not overwrite the host database:

```bash
cd cdk-c
bear --cdb build/compile_commands.json python scripts/build.py --wasi --examples
```

This keeps the WASM JSON under `cdk-c/build/compile_commands.json` so it never conflicts with the host database. Adjust the Bear arguments however you likeâ€”the key point is to keep the host `compile_commands.json` untouched.

### Merge databases for clangd 


```bash
cd cdk-c
python scripts/merge_compile_commands.py
```

- Prefer running the script from inside `cdk-c` so relative include paths remain intuitive; pass `--root /path/to/repo` only when invoking from elsewhere.
- By default the script merges `cdk-c/build/compile_commands.json` (WASM) and `cdk-c/test/build/compile_commands.json` (host) and writes the combined file to `cdk-c/compile_commands.json`.
- Use `--inputs`, `--output`, or `--root` if you keep databases elsewhere, and `--keep-duplicates` if you prefer raw entries.
- Because the script resolves paths to absolutes internally, you can launch it from wherever you are working; it still fills in the correct root-relative locations.

### Language Server

We recommend using **clangd 21** (or compatible version) as the language server for the best IDE experience:

- **clangd 21.1+**: Recommended for optimal compatibility and feature support
- **clang 21.1+**: Should match clangd version for best results

The project is configured to work with clangd 21. If you encounter issues with `-std=c11` or other compiler flags, ensure your clangd version matches your clang version.

**Installation**: See [Clang 21 Installation Guide](clang21-install.md) for quick setup instructions.

## Development Workflow

1. **Build the project** (see [Build Guide](build.md))
2. **Generate compile commands** for IDE support (command above)
3. **Run tests** (see [Test Guide](test.md))
4. **Make changes** and rebuild as needed

## Tips

- The `compile_commands.json` file is git-ignored, so regenerate it after pulling changes or modifying build configuration
- Use `--clean` flag before regenerating compile commands if you encounter stale entries